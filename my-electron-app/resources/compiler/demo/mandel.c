#include <stdint.h>
#include <stddef.h>
#include "vga.h"

// fixed s5.26

#define QP_4 268435456L
#define QP_2 134217728L
#define QP_NEG_1_5 -100663296L
#define QP_0_75 50331648L
#define QP_INV_640 104858L
#define QP_X_MIN -100427366L
#define QP_X_MAX 50095718L
#define QP_Y_MIN -56387174L
#define QP_Y_MAX 56387174L

#define RIGHT 0b0001
#define UP 0b0010
#define DOWN 0b0100
#define LEFT 0b1000
#define MOVEPOWER 6

#define MAX_SCALING 19
const static int32_t DX_SCALE[MAX_SCALING] = {
    235930L, 117965L, 58982L, 29491L,
    14746L, 7373L, 3686L, 1843L,
    922L, 461L, 230L, 115L,
    58L, 29L, 14L, 7L,
    4L, 2L, 1L
};

int32_t xStart = QP_X_MIN;
int32_t yStart = QP_Y_MIN;
uint8_t scale = 0;

uint32_t lastSw = 0;

volatile Vga_t* vgaHandle = (void*) 0x80000000;
volatile uint32_t* sw = (void*) 0x80010004;

int processSw();

int32_t qmul(int32_t a, int32_t b){
    return (int32_t)(((int64_t)a * (int64_t)b) >> 26);
}

void zoomIn(void){
    if(scale == MAX_SCALING - 1) return;
    int32_t dx = DX_SCALE[scale];
    xStart = xStart + 160 * dx;
    yStart = yStart + 120 * dx;
    scale++;
}

void zoomOut(void){
    if(scale == 0) return;
    scale --;
    if(scale == 0){
        xStart = QP_X_MIN;
        yStart = QP_Y_MIN;
        return;
    }
    int32_t dx = DX_SCALE[scale];
    xStart = xStart - 160 * dx;
    yStart = yStart - 120 * dx;
    // check max bounds
    if(xStart + 639 * dx > QP_X_MAX) xStart = QP_X_MAX - 639 * dx;
    if(yStart + 479 * dx > QP_Y_MAX) yStart = QP_Y_MAX - 479 * dx;
    // check min bounds
    if(xStart < QP_X_MIN) xStart = QP_X_MIN;
    if(yStart < QP_Y_MIN) yStart = QP_Y_MIN;
}

void moveFrame(uint8_t dirs){
    int32_t dx = DX_SCALE[scale];
    if(dirs & UP){
        yStart += dx << MOVEPOWER;
    }else if(dirs & DOWN){
        yStart -= dx << MOVEPOWER;
    }
    if(dirs & RIGHT){
        xStart += dx << MOVEPOWER;
    }else if(dirs & LEFT){
        xStart -= dx << MOVEPOWER;
    }
    // check max bounds
    if(xStart + 639 * dx > QP_X_MAX) xStart = QP_X_MAX - 639 * dx;
    if(yStart + 479 * dx > QP_Y_MAX) yStart = QP_Y_MAX - 479 * dx;
    // check min bounds
    if(xStart < QP_X_MIN) xStart = QP_X_MIN;
    if(yStart < QP_Y_MIN) yStart = QP_Y_MIN;
}

uint8_t getIters(int32_t x0, int32_t y0){
    uint16_t maxIters = 255;
    int32_t x = 0;
    int32_t y = 0;
    uint16_t iters = 0;
    for(; iters < maxIters; iters++){
        int32_t xx = qmul(x, x);
        int32_t yy = qmul(y, y);
        if(xx + yy > QP_4) break;
        int32_t newX = xx - yy + x0;
        int32_t newY = (qmul(x, y) << 1) + y0;
        x = newX;
        y = newY;
    }
    return iters;
}

void drawMandel(void){
    int32_t dx = DX_SCALE[scale];
    int32_t y0 = yStart;
    for(size_t j = 0; j < 480; j++){
        int32_t x0 = xStart;
        for(size_t i = 0; i < 640; i++){
            uint8_t iters = getIters(x0, y0);
            vgaHandle->pxlData = iters;
            x0 += dx;
        }
        y0 += dx;
    }
}

void paintBigPixel(uint32_t x, uint32_t y, uint8_t p, uint8_t pow){
    for(uint8_t j = 0; j < 1<<pow; j++){
        vgaHandle->yAddr = y + j;
        vgaHandle->xAddr = x;
        for(uint8_t i =0; i < 1<<pow; i++){
            vgaHandle->pxlData = p;
        }
    }
}

int drawMandelInterlaced(void){
    int32_t dx = DX_SCALE[scale];
    int32_t itersAccum = 0;

    int32_t y0 = yStart;
    for(size_t j = 0; j < 480>>5; j++){
        int32_t x0 = xStart;
        for(size_t i = 0; i < 640>>5; i++){
            uint8_t iters = getIters(x0, y0);
            itersAccum += iters;
            if(itersAccum > 4096){
                if(processSw()) return 1;
                itersAccum = 0;
            }
            paintBigPixel(i<<5, j<<5, iters, 5);
            x0 += dx<<5;
        }
        y0 += dx<<5;
    }

    for(int l = 4; l; l--){
        int32_t y0 = yStart;
        for(size_t j = 0; j < 480>>l; j++){
            int32_t x0 = xStart;
            for(size_t i = 0; i < 640>>l; i++){
                if((j&1)|(i&i)){
                    uint8_t iters = getIters(x0, y0);
                    paintBigPixel(i<<l, j<<l, iters, l);
                    itersAccum += iters;
                    if(itersAccum > 4096){
                        if(processSw()) return 1;
                        itersAccum = 0;
                    }
                }
                x0 += dx<<l;
            }
            y0 += dx<<l;
        }
    }

    y0 = yStart;
    for(size_t j = 0; j < 480; j++){
        int32_t x0 = xStart;
        vgaHandle->yAddr = j;
        for(size_t i = 0; i < 640; i++){
            if((j&1)|(i&i)){
                uint8_t iters = getIters(x0, y0);
                itersAccum += iters;
                vgaHandle->pxlData = iters;
                if(itersAccum > 4096){
                    if(processSw()) return 1;
                    itersAccum = 0;
                }
            }else{
                vgaHandle->xAddr = i+1;
            }
            x0 += dx;
        }
        y0 += dx;
    }
    return 0;
}

void setPalette(uint8_t sw){
    static uint32_t const palette0[256] = {0xffffff,0xfefefe,0xfdfdfd,0xfcfcfc,0xfbfbfb,0xfafafa,0xf9f9f9,0xf8f8f8,0xf7f7f7,0xf6f6f6,0xf5f5f5,0xf4f4f4,0xf3f3f3,0xf2f2f2,0xf1f1f1,0xf0f0f0,0xefefef,0xeeeeee,0xededed,0xececec,0xebebeb,0xeaeaea,0xe9e9e9,0xe8e8e8,0xe7e7e7,0xe6e6e6,0xe5e5e5,0xe4e4e4,0xe3e3e3,0xe2e2e2,0xe1e1e1,0xe0e0e0,0xdfdfdf,0xdedede,0xdddddd,0xdcdcdc,0xdbdbdb,0xdadada,0xd9d9d9,0xd8d8d8,0xd7d7d7,0xd6d6d6,0xd5d5d5,0xd4d4d4,0xd3d3d3,0xd2d2d2,0xd1d1d1,0xd0d0d0,0xcfcfcf,0xcecece,0xcdcdcd,0xcccccc,0xcbcbcb,0xcacaca,0xc9c9c9,0xc8c8c8,0xc7c7c7,0xc6c6c6,0xc5c5c5,0xc4c4c4,0xc3c3c3,0xc2c2c2,0xc1c1c1,0xc0c0c0,0xbfbfbf,0xbebebe,0xbdbdbd,0xbcbcbc,0xbbbbbb,0xbababa,0xb9b9b9,0xb8b8b8,0xb7b7b7,0xb6b6b6,0xb5b5b5,0xb4b4b4,0xb3b3b3,0xb2b2b2,0xb1b1b1,0xb0b0b0,0xafafaf,0xaeaeae,0xadadad,0xacacac,0xababab,0xaaaaaa,0xa9a9a9,0xa8a8a8,0xa7a7a7,0xa6a6a6,0xa5a5a5,0xa4a4a4,0xa3a3a3,0xa2a2a2,0xa1a1a1,0xa0a0a0,0x9f9f9f,0x9e9e9e,0x9d9d9d,0x9c9c9c,0x9b9b9b,0x9a9a9a,0x999999,0x989898,0x979797,0x969696,0x959595,0x949494,0x939393,0x929292,0x919191,0x909090,0x8f8f8f,0x8e8e8e,0x8d8d8d,0x8c8c8c,0x8b8b8b,0x8a8a8a,0x898989,0x888888,0x878787,0x868686,0x858585,0x848484,0x838383,0x828282,0x818181,0x808080,0x7f7f7f,0x7e7e7e,0x7d7d7d,0x7c7c7c,0x7b7b7b,0x7a7a7a,0x797979,0x787878,0x777777,0x767676,0x757575,0x747474,0x737373,0x727272,0x717171,0x707070,0x6f6f6f,0x6e6e6e,0x6d6d6d,0x6c6c6c,0x6b6b6b,0x6a6a6a,0x696969,0x686868,0x676767,0x666666,0x656565,0x646464,0x636363,0x626262,0x616161,0x606060,0x5f5f5f,0x5e5e5e,0x5d5d5d,0x5c5c5c,0x5b5b5b,0x5a5a5a,0x595959,0x585858,0x575757,0x565656,0x555555,0x545454,0x535353,0x525252,0x515151,0x505050,0x4f4f4f,0x4e4e4e,0x4d4d4d,0x4c4c4c,0x4b4b4b,0x4a4a4a,0x494949,0x484848,0x474747,0x464646,0x454545,0x444444,0x434343,0x424242,0x414141,0x404040,0x3f3f3f,0x3e3e3e,0x3d3d3d,0x3c3c3c,0x3b3b3b,0x3a3a3a,0x393939,0x383838,0x373737,0x363636,0x353535,0x343434,0x333333,0x323232,0x313131,0x303030,0x2f2f2f,0x2e2e2e,0x2d2d2d,0x2c2c2c,0x2b2b2b,0x2a2a2a,0x292929,0x282828,0x272727,0x262626,0x252525,0x242424,0x232323,0x222222,0x212121,0x202020,0x1f1f1f,0x1e1e1e,0x1d1d1d,0x1c1c1c,0x1b1b1b,0x1a1a1a,0x191919,0x181818,0x171717,0x161616,0x151515,0x141414,0x131313,0x121212,0x111111,0x101010,0x0f0f0f,0x0e0e0e,0x0d0d0d,0x0c0c0c,0x0b0b0b,0x0a0a0a,0x090909,0x080808,0x070707,0x060606,0x050505,0x040404,0x030303,0x020202,0x010101,0x000000};
    static uint32_t const palette1[256] = {0x9d4200,0x9d4300,0x9e4401,0x9e4401,0x9f4502,0x9f4602,0xa04702,0xa04803,0xa14803,0xa14904,0xa14a04,0xa24b04,0xa24c05,0xa34c05,0xa34d05,0xa44e06,0xa44f06,0xa44f07,0xa55007,0xa55107,0xa65208,0xa65308,0xa75309,0xa75409,0xa85509,0xa8560a,0xa8570a,0xa9570b,0xa9580b,0xaa590b,0xaa5a0c,0xab5b0c,0xab5b0d,0xab5c0d,0xac5d0d,0xac5e0e,0xad5f0e,0xad5f0e,0xae600f,0xae610f,0xaf6210,0xaf6310,0xaf6310,0xb06411,0xb06511,0xb16612,0xb16612,0xb26712,0xb26813,0xb26913,0xb36a14,0xb36a14,0xb46b14,0xb46c15,0xb56d15,0xb56e16,0xb66e16,0xb66f16,0xb67017,0xb77117,0xb77217,0xb87218,0xb87318,0xb97419,0xb97519,0xba7619,0xba761a,0xba771a,0xbb781b,0xbb791b,0xbc791b,0xbc7a1c,0xbd7b1c,0xbd7c1d,0xbd7d1d,0xbe7d1d,0xbe7e1e,0xbf7f1e,0xbf801f,0xc0811f,0xc0811f,0xc18220,0xc18320,0xc18420,0xc28521,0xc28621,0xc38622,0xc38722,0xc48822,0xc48923,0xc58a23,0xc58a24,0xc58b24,0xc68c24,0xc68d25,0xc78e25,0xc78e26,0xc88f26,0xc89026,0xc99127,0xc99227,0xc99228,0xca9328,0xca9428,0xcb9529,0xcb9629,0xcc962a,0xcc972a,0xcd982a,0xcd992b,0xcd9a2b,0xce9a2c,0xce9b2c,0xcf9c2c,0xcf9d2d,0xd09e2d,0xd09f2e,0xd19f2e,0xd1a02e,0xd2a12f,0xd2a22f,0xd2a330,0xd3a330,0xd3a430,0xd4a531,0xd4a631,0xd5a732,0xd5a732,0xd6a832,0xd6a933,0xd7aa33,0xd7ab34,0xd7ac34,0xd8ac34,0xd8ad35,0xd9ae35,0xd9af36,0xdab036,0xdab137,0xdbb137,0xdbb237,0xdcb338,0xdcb438,0xdcb539,0xddb639,0xddb639,0xdeb73a,0xdeb83a,0xdfb93b,0xdfba3b,0xe0ba3b,0xe0bb3c,0xe1bc3c,0xe1bd3d,0xe1be3d,0xe2bf3d,0xe2bf3e,0xe3c03e,0xe3c13f,0xe4c23f,0xe4c340,0xe5c440,0xe5c440,0xe6c541,0xe6c641,0xe7c742,0xe7c842,0xe7c942,0xe8c943,0xe8ca43,0xe9cb44,0xe9cc44,0xeacd44,0xeace45,0xebcf45,0xebcf46,0xecd046,0xecd147,0xedd247,0xedd347,0xeed448,0xeed448,0xeed549,0xefd649,0xefd749,0xf0d84a,0xf0d94a,0xf1d94b,0xf1da4b,0xf2db4c,0xf2dc4c,0xf3dd4c,0xf3de4d,0xf4df4d,0xf4df4e,0xf5e04e,0xf5e14e,0xf5e24f,0xf6e34f,0xf6e450,0xf7e550,0xf7e551,0xf8e651,0xf8e751,0xf9e852,0xf9e952,0xfaea53,0xfaeb53,0xfbeb54,0xfbec54,0xfced54,0xfcee55,0xfdef55,0xfdf056,0xfef056,0xfef156,0xfef257,0xfff357,0xfff45c,0xfff462,0xfff468,0xfff56d,0xfff572,0xfff677,0xfff67c,0xfff680,0xfff785,0xfff789,0xfff88e,0xfff892,0xfff896,0xfff99b,0xfff99f,0xfff9a2,0xfffaa7,0xfffaaa,0xfffaae,0xfffab2,0xfffbb6,0xfffbb9,0xfffbbd,0xfffcc1,0xfffcc4,0xfffcc7,0xfffccb,0xfffdce,0xfffdd2,0xfffdd5,0xfffdd8,0xfffedb,0xfffede,0xfffee2,0xffffe5,0xffffe8,0xffffeb,0xffffee};
    static uint32_t const palette2[256] = {0x598dfc,0x5a8efc,0x5b8ffc,0x5b90fc,0x5c91fc,0x5d91fc,0x5e92fc,0x5f93fc,0x5f94fc,0x6095fc,0x6196fc,0x6297fc,0x6398fc,0x6399fc,0x649afc,0x659afc,0x669bfc,0x679cfc,0x679dfc,0x689efc,0x699ffc,0x6aa0fc,0x6ba1fd,0x6ba2fd,0x6ca2fd,0x6da3fd,0x6ea4fd,0x6fa5fd,0x6fa6fd,0x70a7fd,0x71a8fd,0x72a9fd,0x73aafd,0x73abfd,0x74abfd,0x75acfd,0x76adfd,0x77aefd,0x77affd,0x78b0fd,0x79b1fd,0x7ab2fd,0x7bb3fd,0x7bb3fd,0x7cb4fd,0x7db5fd,0x7eb6fd,0x7fb7fd,0x7fb8fd,0x80b9fd,0x81bafd,0x82bbfd,0x83bbfd,0x83bcfd,0x84bdfd,0x85befd,0x86bffd,0x87c0fd,0x87c1fd,0x88c2fd,0x89c3fd,0x8ac4fd,0x8bc4fd,0x8bc5fd,0x8cc6fe,0x8dc7fe,0x8ec8fe,0x8fc9fe,0x8fcafe,0x90cbfe,0x91ccfe,0x92ccfe,0x93cdfe,0x93cefe,0x94cffe,0x95d0fe,0x96d1fe,0x97d2fe,0x97d3fe,0x98d4fe,0x99d5fe,0x9ad5fe,0x9bd6fe,0x9bd7fe,0x9cd8fe,0x9dd9fe,0x9edafe,0x9fdbfe,0x9fdcfe,0xa0ddfe,0xa1ddfe,0xa2defe,0xa3dffe,0xa3e0fe,0xa4e1fe,0xa5e2fe,0xa6e3fe,0xa7e4fe,0xa7e5fe,0xa8e6fe,0xa9e6fe,0xaae7fe,0xabe8fe,0xabe9fe,0xaceafe,0xadebfe,0xaeecfe,0xafedff,0xafeeff,0xb0eeff,0xb1efff,0xb2f0ff,0xb3f1ff,0xb3f2ff,0xb4f3ff,0xb5f4ff,0xb6f5ff,0xb7f6ff,0xb7f7ff,0xb8f7ff,0xb9f8ff,0xbaf9ff,0xbbfaff,0xbbfbff,0xbcfcff,0xbdfdff,0xbefeff,0xbfffff,0xbfffff,0xbefffe,0xbefefd,0xbefefc,0xbdfefb,0xbdfdfb,0xbdfdfa,0xbcfdf9,0xbcfcf8,0xbcfcf7,0xbbfcf7,0xbbfbf6,0xbbfbf5,0xbafbf4,0xbafaf3,0xbafaf3,0xb9faf2,0xb9f9f1,0xb9f9f0,0xb8f9ef,0xb8f8ef,0xb8f8ee,0xb7f8ed,0xb7f7ec,0xb7f7eb,0xb6f7eb,0xb6f6ea,0xb6f6e9,0xb5f6e8,0xb5f5e7,0xb5f5e7,0xb4f5e6,0xb4f4e5,0xb4f4e4,0xb3f4e3,0xb3f3e3,0xb3f3e2,0xb2f3e1,0xb2f2e0,0xb2f2df,0xb1f2df,0xb1f1de,0xb1f1dd,0xb0f1dc,0xb0f0db,0xb0f0db,0xaff0da,0xafefd9,0xafefd8,0xaeefd7,0xaeeed7,0xaeeed6,0xadeed5,0xadedd4,0xadedd3,0xacedd3,0xacecd2,0xacecd1,0xabecd0,0xabebcf,0xabebcf,0xaaebce,0xaaeacd,0xaaeacc,0xa9eacb,0xa9e9cb,0xa9e9ca,0xa8e9c9,0xa8e8c8,0xa8e8c7,0xa7e8c7,0xa7e7c6,0xa7e7c5,0xa6e7c4,0xa6e6c3,0xa6e6c3,0xa5e6c2,0xa5e5c1,0xa5e5c0,0xa4e5bf,0xa4e4bf,0xa4e4be,0xa3e4bd,0xa3e3bc,0xa3e3bb,0xa2e3bb,0xa2e3ba,0xa1e2b9,0xa1e2b8,0xa1e2b7,0xa0e1b7,0xa0e1b6,0xa0e1b5,0x9fe0b4,0x9fe0b3,0x9fe0b3,0x9edfb2,0x9edfb1,0x9edfb0,0x9ddeaf,0x9ddeaf,0x9ddeae,0x9cddad,0x9cddac,0x9cddab,0x9bdcab,0x9bdcaa,0x9bdca9,0x9adba8,0x9adba7,0x9adba7,0x99daa6,0x99daa5,0x99daa4,0x98d9a3,0x98d9a3,0x98d9a2,0x97d8a1,0x97d8a0,0x97d89f,0x96d79f,0x96d79e,0x96d79d,0x95d69c,0x95d69b,0x95d69b,0x94d59a,0x94d599};
    static uint32_t const palette3[256] = {0xccffff,0xccfefe,0xcbfefc,0xcbfdfb,0xcafdf9,0xcafcf8,0xcafcf6,0xc9fbf5,0xc9faf3,0xc9faf2,0xc8f9f0,0xc8f9ef,0xc7f8ed,0xc7f7ec,0xc7f7ea,0xc6f6e9,0xc6f6e7,0xc6f5e6,0xc5f5e4,0xc5f4e3,0xc4f3e2,0xc4f3e0,0xc4f2df,0xc3f2dd,0xc3f1dc,0xc3f0da,0xc2f0d9,0xc2efd7,0xc1efd6,0xc1eed4,0xc1eed3,0xc0edd1,0xc0ecd0,0xc0ecce,0xbfebcd,0xbfebcb,0xbeeaca,0xbeeac8,0xbee9c7,0xbde8c5,0xbde8c4,0xbde7c3,0xbce7c1,0xbce6c0,0xbbe5be,0xbbe5bd,0xbbe4bb,0xbae4ba,0xbae3b8,0xbae3b7,0xb9e2b5,0xb9e1b4,0xb8e1b2,0xb8e0b1,0xb8e0af,0xb7dfae,0xb7deac,0xb7deab,0xb6dda9,0xb6dda8,0xb5dca7,0xb5dca5,0xb5dba4,0xb4daa2,0xb4daa1,0xb4d99f,0xb5d99e,0xb5d89c,0xb5d89b,0xb5d799,0xb6d698,0xb6d696,0xb6d595,0xb6d593,0xb7d492,0xb7d490,0xb7d38f,0xb7d38d,0xb8d28c,0xb8d18a,0xb8d189,0xb8d087,0xb9d086,0xb9cf84,0xb9cf83,0xb9ce81,0xbacd7f,0xbacd7e,0xbacc7c,0xbacc7b,0xbbcb79,0xbbcb78,0xbbca76,0xbbc975,0xbcc973,0xbcc872,0xbcc870,0xbcc76f,0xbdc76d,0xbdc66c,0xbdc66a,0xbdc569,0xbec467,0xbec466,0xbec364,0xbec363,0xbfc261,0xbfc260,0xbfc15e,0xbfc05d,0xc0c05b,0xc0bf5a,0xc0bf58,0xc0be57,0xc1be55,0xc1bd54,0xc1bc52,0xc1bc51,0xc2bb4f,0xc2bb4e,0xc2ba4c,0xc2ba4b,0xc3b949,0xc3b948,0xc3b846,0xc3b745,0xc4b743,0xc4b642,0xc4b641,0xc4b541,0xc4b440,0xc3b340,0xc3b240,0xc3b13f,0xc3b03f,0xc3b03f,0xc2af3e,0xc2ae3e,0xc2ad3e,0xc2ac3d,0xc2ab3d,0xc1aa3d,0xc1a93c,0xc1a93c,0xc1a83c,0xc1a73b,0xc1a63b,0xc0a53b,0xc0a43a,0xc0a33a,0xc0a33a,0xc0a239,0xbfa139,0xbfa039,0xbf9f38,0xbf9e38,0xbf9d38,0xbe9d37,0xbe9c37,0xbe9b37,0xbe9a36,0xbe9936,0xbe9836,0xbd9735,0xbd9735,0xbd9635,0xbd9534,0xbd9434,0xbc9334,0xbc9233,0xbc9133,0xbc9033,0xbc9032,0xbb8f32,0xbb8e32,0xbb8d31,0xbb8c31,0xbb8b31,0xba8a30,0xba8a30,0xba8930,0xba882f,0xba872f,0xba862f,0xb9852e,0xb9842e,0xb9842e,0xb9832d,0xb9822d,0xb8812d,0xb8802c,0xb87f2c,0xb87e2c,0xb77d2c,0xb67c2c,0xb67b2c,0xb5792b,0xb5782b,0xb4772b,0xb4762b,0xb3752b,0xb2742b,0xb2722b,0xb1712b,0xb1702b,0xb06f2a,0xb06e2a,0xaf6c2a,0xaf6b2a,0xae6a2a,0xad692a,0xad682a,0xac672a,0xac652a,0xab642a,0xab6329,0xaa6229,0xa96129,0xa96029,0xa85e29,0xa85d29,0xa75c29,0xa75b29,0xa65a29,0xa65828,0xa55728,0xa45628,0xa45528,0xa35428,0xa35328,0xa25128,0xa25028,0xa14f28,0xa04e27,0xa04d27,0x9f4c27,0x9f4a27,0x9e4927,0x9e4827,0x9d4727,0x9c4627,0x9c4427,0x9b4326,0x9b4226,0x9a4126,0x9a4026,0x993f26,0x993d26,0x983c26,0x973b26,0x973a26,0x963925,0x963825,0x953625,0x953525,0x943425};
    static uint32_t const palette4[256] = {0xe2ebfe,0xe1eafe,0xe1e9fe,0xe0e8fe,0xdfe7fe,0xdee6fe,0xdee5fe,0xdde4fe,0xdce3fe,0xdbe2fe,0xdbe1fd,0xdae0fd,0xd9dffd,0xd8defd,0xd8ddfd,0xd7dcfd,0xd6dbfd,0xd6dafd,0xd5d9fd,0xd4d8fd,0xd3d7fd,0xd3d6fd,0xd2d5fd,0xd1d4fd,0xd0d3fd,0xd0d2fd,0xcfd1fd,0xced0fd,0xced0fd,0xcdcefc,0xcccdfc,0xcbccfc,0xcacbfc,0xcacbfc,0xc9c9fc,0xc8c8fc,0xc8c7fc,0xc7c6fc,0xc6c5fc,0xc5c4fc,0xc4c3fc,0xc4c2fc,0xc3c1fc,0xc2c0fc,0xc1bffc,0xc1befc,0xc0bdfc,0xbfbcfb,0xbebbfb,0xbebafb,0xbdb9fb,0xbcb8fb,0xbbb7fb,0xbbb6fb,0xbab5fb,0xb9b4fb,0xb9b3fb,0xb8b2fb,0xb8b1fb,0xb8b0fb,0xb7affb,0xb7aefb,0xb7adfb,0xb6abfb,0xb6aafa,0xb6a9fa,0xb5a8fa,0xb5a7fa,0xb5a6fa,0xb4a5fa,0xb4a4fa,0xb3a3fa,0xb3a1fa,0xb3a0fa,0xb29ffa,0xb29efa,0xb29dfa,0xb19cfa,0xb19bfa,0xb19afa,0xb098fa,0xb097f9,0xb096f9,0xaf95f9,0xaf94f9,0xae93f9,0xae91f9,0xae90f9,0xad8ff9,0xad8ef9,0xad8df9,0xac8bf9,0xac8af9,0xab89f9,0xab88f9,0xab87f9,0xaa85f9,0xaa84f8,0xaa83f8,0xa982f8,0xa980f8,0xa87ff8,0xa87ef8,0xa87df8,0xa77bf8,0xa77af8,0xa679f8,0xa678f8,0xa676f8,0xa575f8,0xa574f8,0xa472f8,0xa471f7,0xa370f7,0xa36ef7,0xa36df7,0xa26bf7,0xa26af7,0xa169f7,0xa167f7,0xa166f6,0xa066f5,0xa065f5,0xa064f4,0x9f63f4,0x9f62f3,0x9f61f2,0x9f60f2,0x9e5ff1,0x9e5ef0,0x9e5df0,0x9d5cef,0x9d5bee,0x9d5aee,0x9c59ed,0x9c58ed,0x9c57ec,0x9c56eb,0x9b55eb,0x9b54ea,0x9b53e9,0x9a52e9,0x9a51e8,0x9a50e7,0x9a4fe7,0x994ee6,0x994de5,0x994ce5,0x984be4,0x984ae3,0x9849e3,0x9748e2,0x9747e1,0x9746e1,0x9645e0,0x9644df,0x9642df,0x9541de,0x9540dd,0x953fdd,0x953edc,0x943ddb,0x943cda,0x943bda,0x933ad9,0x9339d8,0x9338d8,0x9237d7,0x9235d6,0x9234d5,0x9133d5,0x9132d4,0x9131d3,0x9030d3,0x902fd2,0x902ed1,0x8f2cd0,0x8f2bd0,0x8e2acf,0x8e29ce,0x8e28cd,0x8d26cc,0x8d25cc,0x8d24cb,0x8c23ca,0x8c22c9,0x8c20c8,0x8b1fc8,0x8b1ec7,0x8a1cc6,0x8a1bc5,0x8a1bc4,0x891ac3,0x891ac2,0x8919c1,0x8919bf,0x8819be,0x8818bd,0x8818bc,0x8717bb,0x8717ba,0x8717b8,0x8616b7,0x8616b6,0x8615b5,0x8615b4,0x8515b3,0x8514b1,0x8514b0,0x8413af,0x8413ae,0x8413ad,0x8412ac,0x8312aa,0x8311a9,0x8311a8,0x8211a7,0x8210a6,0x8210a5,0x810fa3,0x810fa2,0x810fa1,0x810ea0,0x800e9f,0x800d9e,0x800d9c,0x7f0d9b,0x7f0c9a,0x7f0c99,0x7f0b98,0x7e0b97,0x7e0b95,0x7e0a94,0x7d0a93,0x7d0992,0x7d0991,0x7c0990,0x7c088f,0x7c088d,0x7c078c,0x7b078b,0x7b078a,0x7b0689,0x7a0688,0x7a0586,0x7a0585,0x7a0584,0x790483,0x790482,0x790381,0x780380,0x78037e,0x78027d,0x78027c,0x77017b,0x77017a};
    static uint32_t const palette5[256] = {0x87080d,0x880811,0x890815,0x8a0818,0x8a081b,0x8b081e,0x8c0821,0x8c0824,0x8d0826,0x8e0829,0x8e082b,0x8f082e,0x8f0830,0x900832,0x900835,0x910837,0x910839,0x92083b,0x92083d,0x93083f,0x930841,0x940843,0x940845,0x950847,0x950849,0x96084b,0x96094d,0x97094f,0x970951,0x980953,0x980954,0x980956,0x990958,0x99095a,0x9a095c,0x9a095d,0x9b095f,0x9b0961,0x9b0963,0x9c0964,0x9c0966,0x9d0968,0x9d0969,0x9d096b,0x9e096d,0x9e096f,0x9f0970,0x9f0972,0x9f0974,0xa00975,0xa00977,0xa10979,0xa1097a,0xa1097c,0xa2097e,0xa2097f,0xa30981,0xa30982,0xa30984,0xa40986,0xa40987,0xa50989,0xa5098b,0xa40a8c,0xa30c8e,0xa10e90,0xa01092,0x9f1293,0x9d1395,0x9c1597,0x9b1798,0x9a189a,0x991a9b,0x981b9c,0x971d9e,0x961e9f,0x951fa1,0x9321a2,0x9222a3,0x9223a5,0x9125a6,0x9026a7,0x8f27a8,0x8e29aa,0x8d2aab,0x8c2bac,0x8b2cad,0x8a2eae,0x892faf,0x8830b1,0x8731b2,0x8732b3,0x8634b4,0x8535b5,0x8436b6,0x8337b7,0x8238b8,0x8139ba,0x813abb,0x803cbc,0x7f3dbd,0x7e3ebe,0x7d3fbf,0x7d40c0,0x7c41c1,0x7b42c2,0x7a43c3,0x7944c4,0x7945c5,0x7846c6,0x7747c7,0x7649c8,0x764ac9,0x754bca,0x744ccb,0x734dcc,0x724ecd,0x724fce,0x7150cf,0x7051d0,0x6f52d1,0x6f53d2,0x6e54d3,0x6d55d4,0x6d56d5,0x6c57d6,0x6b58d7,0x6a59d8,0x6a5ad9,0x695bda,0x685cdb,0x675ddb,0x665fdc,0x6560dd,0x6561dd,0x6463de,0x6364de,0x6265df,0x6167df,0x6068e0,0x6069e0,0x5f6be1,0x5e6ce1,0x5d6de2,0x5c6fe2,0x5c70e2,0x5b71e3,0x5a73e3,0x5974e4,0x5875e4,0x5876e5,0x5778e5,0x5679e6,0x557ae6,0x547be7,0x547de7,0x537ee8,0x527fe8,0x5180e9,0x5181e9,0x5083e9,0x4f84ea,0x4e85ea,0x4e86eb,0x4d88eb,0x4c89ec,0x4b8aec,0x4b8bed,0x4a8ced,0x498dee,0x488fee,0x4890ee,0x4791ef,0x4692ef,0x4593f0,0x4595f0,0x4496f1,0x4397f1,0x4298f2,0x4299f2,0x419af2,0x409cf3,0x409df3,0x3f9ef4,0x3e9ff4,0x3da0f5,0x3da1f5,0x3ca2f5,0x3ba4f6,0x3ba5f6,0x3aa6f7,0x39a7f7,0x38a8f8,0x38a9f8,0x37aaf8,0x36acf9,0x36adf9,0x35aefa,0x34affa,0x33b0fb,0x33b1fb,0x32b2fb,0x31b4fc,0x31b5fc,0x30b6fd,0x2fb7fd,0x2eb8fe,0x2eb9fe,0x2dbafe,0x2cbbff,0x2cbdff,0x2cbefe,0x2bc0fe,0x2bc1fe,0x2bc2fd,0x2bc4fd,0x2ac5fd,0x2ac7fc,0x2ac8fc,0x2ac9fc,0x29cbfb,0x29ccfb,0x29cefb,0x29cffa,0x28d0fa,0x28d2fa,0x28d3f9,0x28d4f9,0x27d6f9,0x27d7f8,0x27d8f8,0x27daf8,0x26dbf7,0x26ddf7,0x26def7,0x26dff6,0x25e0f6,0x25e2f6,0x25e3f5,0x25e4f5,0x24e6f5,0x24e7f4,0x24e8f4,0x24eaf4,0x24ebf3,0x23ecf3,0x23eef3,0x23eff3,0x23f0f2,0x22f1f2,0x22f3f2,0x22f4f1,0x22f5f1,0x21f6f1,0x21f8f0,0x21f9f0};
    static uint32_t const palette6[256] = {0x640700,0x660901,0x670a01,0x690c02,0x6a0d02,0x6c0f03,0x6e1003,0x6f1204,0x711404,0x731505,0x741705,0x761806,0x771a06,0x791b07,0x7b1d07,0x7c1f08,0x7e2008,0x7f2209,0x812309,0x83250a,0x84260a,0x86280b,0x882a0b,0x892b0c,0x8b2d0c,0x8c2e0d,0x8e300d,0x90310e,0x91330e,0x93340f,0x94360f,0x963810,0x983910,0x993b11,0x9b3c11,0x9d3e12,0x9e3f12,0xa04113,0xa14313,0xa34414,0xa54614,0xa64715,0xa84915,0xa94a16,0xab4c16,0xad4e17,0xae4f17,0xb05118,0xb25218,0xb35419,0xb55519,0xb6571a,0xb8591a,0xba5a1b,0xbb5c1b,0xbd5d1c,0xbe5f1c,0xc0601d,0xc2621d,0xc3641e,0xc5651e,0xc7671f,0xc8681f,0xca6a20,0xcb6c21,0xcc6e24,0xcd7027,0xce732a,0xce752e,0xcf7731,0xd07a34,0xd17c37,0xd27e3b,0xd3803e,0xd38341,0xd48544,0xd58747,0xd68a4b,0xd78c4e,0xd78e51,0xd89154,0xd99357,0xda955b,0xdb985e,0xdc9a61,0xdc9c64,0xdd9f68,0xdea16b,0xdfa36e,0xe0a671,0xe0a874,0xe1aa78,0xe2ad7b,0xe3af7e,0xe4b181,0xe4b484,0xe5b688,0xe6b88b,0xe7bb8e,0xe8bd91,0xe9bf95,0xe9c198,0xeac49b,0xebc69e,0xecc8a1,0xedcba5,0xedcda8,0xeecfab,0xefd2ae,0xf0d4b2,0xf1d6b5,0xf2d9b8,0xf2dbbb,0xf3ddbe,0xf4e0c2,0xf5e2c5,0xf6e4c8,0xf6e7cb,0xf7e9ce,0xf8ebd2,0xf9eed5,0xfaf0d8,0xfbf2db,0xfbf5df,0xfcf7e2,0xfdf9e5,0xfefce8,0xfffeeb,0xfdfeed,0xf9fded,0xf5fcee,0xf1faee,0xedf9ee,0xe9f8ef,0xe5f6ef,0xe1f5ef,0xddf4ef,0xd9f2f0,0xd5f1f0,0xd1f0f0,0xcdeef1,0xc9edf1,0xc5ecf1,0xc1eaf1,0xbde9f2,0xb9e8f2,0xb5e6f2,0xb1e5f3,0xade4f3,0xa9e2f3,0xa5e1f3,0xa1e0f4,0x9ddef4,0x99ddf4,0x95dcf4,0x91daf5,0x8dd9f5,0x89d8f5,0x85d6f6,0x81d5f6,0x7dd4f6,0x79d2f6,0x75d1f7,0x71d0f7,0x6dcef7,0x69cdf8,0x65ccf8,0x61caf8,0x5dc9f8,0x59c8f9,0x55c6f9,0x51c5f9,0x4dc4fa,0x49c2fa,0x45c1fa,0x41c0fa,0x3dbefb,0x39bdfb,0x35bcfb,0x31bafc,0x2db9fc,0x29b8fc,0x25b6fc,0x21b5fd,0x1db4fd,0x19b2fd,0x15b1fe,0x11b0fe,0x0daefe,0x09adfe,0x05acff,0x01aaff,0x00a8fc,0x00a5f8,0x00a3f4,0x00a0f0,0x009dec,0x009be8,0x0098e4,0x0096e0,0x0093dc,0x0090d8,0x008ed4,0x008bd0,0x0088cc,0x0086c8,0x0083c4,0x0080c0,0x007ebc,0x007bb8,0x0079b4,0x0076b0,0x0073ac,0x0071a8,0x006ea4,0x006ba0,0x00699c,0x006698,0x006494,0x006190,0x005e8c,0x005c88,0x005984,0x005680,0x00547c,0x005178,0x004e74,0x004c70,0x00496c,0x004768,0x004464,0x004160,0x003f5c,0x003c58,0x003954,0x003750,0x00344c,0x003148,0x002f44,0x002c40,0x002a3c,0x002738,0x002434,0x002230,0x001f2c,0x001c28,0x001a24,0x001720,0x00141c,0x001218,0x000f14,0x000d10,0x000a0c,0x000708,0x000504,0x000200};
    static uint32_t const palette7[256] = {0x0000ff,0x0006ff,0x000cff,0x0012ff,0x0018ff,0x001eff,0x0024ff,0x002aff,0x0030ff,0x0036ff,0x003cff,0x0042ff,0x0048ff,0x004eff,0x0054ff,0x005aff,0x0060ff,0x0066ff,0x006cff,0x0072ff,0x0078ff,0x007eff,0x0084ff,0x008aff,0x0090ff,0x0096ff,0x009cff,0x00a2ff,0x00a8ff,0x00aeff,0x00b4ff,0x00baff,0x00c0ff,0x00c6ff,0x00ccff,0x00d2ff,0x00d8ff,0x00deff,0x00e4ff,0x00eaff,0x00f0ff,0x00f6ff,0x00fcff,0x00fffc,0x00fff6,0x00fff0,0x00ffea,0x00ffe4,0x00ffde,0x00ffd8,0x00ffd2,0x00ffcc,0x00ffc6,0x00ffc0,0x00ffba,0x00ffb4,0x00ffae,0x00ffa8,0x00ffa2,0x00ff9c,0x00ff96,0x00ff90,0x00ff8a,0x00ff84,0x00ff7e,0x00ff78,0x00ff72,0x00ff6c,0x00ff66,0x00ff60,0x00ff5a,0x00ff54,0x00ff4e,0x00ff48,0x00ff42,0x00ff3c,0x00ff36,0x00ff30,0x00ff2a,0x00ff24,0x00ff1e,0x00ff18,0x00ff12,0x00ff0c,0x00ff06,0x00ff00,0x06ff00,0x0cff00,0x12ff00,0x18ff00,0x1eff00,0x24ff00,0x2aff00,0x30ff00,0x36ff00,0x3cff00,0x42ff00,0x48ff00,0x4eff00,0x54ff00,0x5aff00,0x60ff00,0x66ff00,0x6cff00,0x72ff00,0x78ff00,0x7eff00,0x84ff00,0x8aff00,0x90ff00,0x96ff00,0x9cff00,0xa2ff00,0xa8ff00,0xaeff00,0xb4ff00,0xbaff00,0xc0ff00,0xc6ff00,0xccff00,0xd2ff00,0xd8ff00,0xdeff00,0xe4ff00,0xeaff00,0xf0ff00,0xf6ff00,0xfcff00,0xfffc00,0xfff600,0xfff000,0xffea00,0xffe400,0xffde00,0xffd800,0xffd200,0xffcc00,0xffc600,0xffc000,0xffba00,0xffb400,0xffae00,0xffa800,0xffa200,0xff9c00,0xff9600,0xff9000,0xff8a00,0xff8400,0xff7e00,0xff7800,0xff7200,0xff6c00,0xff6600,0xff6000,0xff5a00,0xff5400,0xff4e00,0xff4800,0xff4200,0xff3c00,0xff3600,0xff3000,0xff2a00,0xff2400,0xff1e00,0xff1800,0xff1200,0xff0c00,0xff0600,0xff0000,0xff0006,0xff000c,0xff0012,0xff0018,0xff001e,0xff0024,0xff002a,0xff0030,0xff0036,0xff003c,0xff0042,0xff0048,0xff004e,0xff0054,0xff005a,0xff0060,0xff0066,0xff006c,0xff0072,0xff0078,0xff007e,0xff0084,0xff008a,0xff0090,0xff0096,0xff009c,0xff00a2,0xff00a8,0xff00ae,0xff00b4,0xff00ba,0xff00c0,0xff00c6,0xff00cc,0xff00d2,0xff00d8,0xff00de,0xff00e4,0xff00ea,0xff00f0,0xff00f6,0xff00fc,0xfc00ff,0xf600ff,0xf000ff,0xea00ff,0xe400ff,0xde00ff,0xd800ff,0xd200ff,0xcc00ff,0xc600ff,0xc000ff,0xba00ff,0xb400ff,0xae00ff,0xa800ff,0xa200ff,0x9c00ff,0x9600ff,0x9000ff,0x8a00ff,0x8400ff,0x7f00fe,0x7900fe,0x7300fe,0x6d00fe,0x6700fe,0x6100fe,0x5b00fe,0x5500fe,0x4f00fe,0x4900fe,0x4300fe,0x3d00fe,0x3700fe,0x3100fe,0x2b00fe,0x2500fe,0x1f00fe,0x1900fe,0x1300fe,0x0d00fe,0x0700fe,0x0100fe};
    static uint32_t const * const palettes[8] = {palette0, palette1, palette2, palette3, palette4, palette5, palette6, palette7};
    uint8_t const dir = sw & 0x1;
    uint32_t const * const palette = palettes[sw>>1];
    if(dir) for(int i = 0; i < 256; i++) vgaHandle->pltData = palette[i];
    else for(int i = 255; i >= 0; i--) vgaHandle->pltData = palette[i];
}

int processSw(){
    uint32_t newSw = *sw;
    int ret = 0;
    if(newSw != lastSw){
        uint32_t changes = newSw & ~lastSw;
        if(changes&0xf){
            ret = 1;
            moveFrame(changes&0xf);
        }
        if(changes&0x10){
            ret = 1;
            zoomIn();
        }
        if(changes & 0x20){
            ret = 1;
            zoomOut();
        }
        uint32_t flips = newSw ^ lastSw;
        if((flips >> 6) & 0xf) setPalette((newSw >> 6) & 0xf);
    }
    lastSw = newSw;
    return ret;
}

int main(void){
    // enable video
    vgaHandle->en = 1;
    // set palette
    setPalette(0b1100);
    // set pixel address to 0
    // vgaHandle->xAddr = 0;
    // vgaHandle->yAddr = 0;
    // draw
    for(;;){
        int update = drawMandelInterlaced();
        if(!update){
            while(!processSw());
        }
    }
    return 0;
}
